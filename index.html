<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Members Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ================== IMPROVED CSS ================== */
:root {
  --primary-color: #ec530d;
  --secondary-color: #004a6e;
  --text-color: #333;
  --light-gray: #f4f6f8;
  --border-color: #ddd;
  --error-color: #dc3545;
  --success-color: #28a745;
  --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

body {
  margin: 0;
  background: var(--light-gray);
  color: var(--text-color);
  line-height: 1.6;
}

.app {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  flex-wrap: wrap;
  gap: 15px;
}

.header h2 {
  margin: 0;
  font-size: 2rem;
  color: var(--primary-color);
}

.add-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--primary-color);
  color: #fff;
  border: none;
  padding: 12px 20px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: 600;
  transition: var(--transition);
  box-shadow: 0 3px 8px rgba(0, 98, 145, 0.2);
}

.add-btn:hover {
  background: var(--secondary-color);
  transform: translateY(-2px);
}

/* Grid */
.members-container {
  background: #fff;
  border-radius: 16px;
  padding: 25px;
  box-shadow: var(--card-shadow);
}

.member-count {
  font-size: 16px;
  color: #666;
  margin-bottom: 20px;
}

.member-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

.member-card {
  background: #fff;
  padding: 25px 15px;
  border-radius: 12px;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  border: 1px solid var(--border-color);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  aspect-ratio: 1;
  min-height: 180px;
}

.member-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  border-color: var(--primary-color);
}

.member-card img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--light-gray);
  margin-bottom: 15px;
}

.member-card h4 {
  font-size: 16px;
  margin: 0;
  font-weight: 600;
  color: var(--text-color);
  line-height: 1.3;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

/* Empty state */
.empty-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.empty-state i {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.empty-state p {
  margin: 0;
  font-size: 16px;
}

/* Form */
.form-section {
  background: #fff;
  padding: 25px;
  border-radius: 16px;
  margin-top: 25px;
  box-shadow: var(--card-shadow);
}

.form-section h3 {
  margin-top: 0;
  color: var(--primary-color);
  font-size: 20px;
  margin-bottom: 25px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #555;
}

.form-group input {
  width: 100%;
  padding: 14px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-size: 16px;
  transition: var(--transition);
}

.form-group input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(0, 98, 145, 0.1);
}

.file-input-wrapper {
  position: relative;
  overflow: hidden;
  display: inline-block;
  width: 100%;
}

.file-input-wrapper input[type="file"] {
  position: absolute;
  left: 0;
  top: 0;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.file-input-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  background: var(--light-gray);
  border: 2px dashed var(--border-color);
  border-radius: 8px;
  color: #666;
  cursor: pointer;
  transition: var(--transition);
  justify-content: center;
}

.file-input-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
}

/* Camera button styles */
.file-input-container {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-top: 5px;
}

.camera-btn {
  background: var(--primary-color);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  transition: var(--transition);
  white-space: nowrap;
}

.camera-btn:hover {
  background: var(--secondary-color);
  transform: translateY(-2px);
}

.camera-btn i {
  font-size: 16px;
}

.file-selection {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.file-selection p {
  margin: 0;
  font-size: 13px;
  color: #666;
}

.file-name {
  font-size: 12px;
  color: #666;
  margin-top: 5px;
}

.form-actions {
  display: flex;
  gap: 15px;
  margin-top: 30px;
}

.submit-btn, .cancel-btn {
  flex: 1;
  padding: 16px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.submit-btn {
  background: var(--primary-color);
  color: #fff;
}

.submit-btn:hover {
  background: var(--secondary-color);
}

.cancel-btn {
  background: #f8f9fa;
  color: #666;
  border: 1px solid var(--border-color);
}

.cancel-btn:hover {
  background: #e9ecef;
}

.error-msg {
  color: var(--error-color);
  font-size: 14px;
  margin-top: 5px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.success-msg {
  color: var(--success-color);
  font-size: 14px;
  margin-top: 5px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.hidden {
  display: none !important;
}

/* Progress Bar */
.progress-container {
  margin-top: 10px;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background-color: #f0f0f0;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 5px;
}

.progress-fill {
  height: 100%;
  background-color: var(--primary-color);
  border-radius: 3px;
  width: 0%;
  transition: width 0.3s ease;
}

.progress-text {
  font-size: 12px;
  color: #666;
  text-align: center;
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
  backdrop-filter: blur(5px);
}

.modal-content {
  background: #fff;
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 30px;
  border-radius: 16px;
  position: relative;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.close-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  border: none;
  background: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  transition: var(--transition);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  background: #f5f5f5;
  color: #333;
}

.profile-img {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  display: block;
  margin: 0 auto 20px;
  object-fit: cover;
  border: 5px solid var(--light-gray);
}

.modal h3 {
  text-align: center;
  margin: 0 0 25px 0;
  color: var(--primary-color);
  font-size: 24px;
}

.modal-info {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 30px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 10px;
}

.info-item i {
  width: 24px;
  color: var(--primary-color);
}

.aadhaar-section {
  margin-top: 30px;
}

.aadhaar-section h4 {
  margin-bottom: 15px;
  color: #555;
}

.aadhaar-images {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.aadhaar-img-wrapper {
  text-align: center;
}

.aadhaar-label {
  font-size: 12px;
  color: #666;
  margin-bottom: 8px;
}

.aadhaar-img {
  width: 100%;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.aadhaar-img:hover {
  transform: scale(1.02);
}

/* Camera modal specific styles */
.camera-container {
  position: relative;
}

#cameraPreview {
  width: 100%;
  max-height: 400px;
  object-fit: contain;
  background: #000;
  border-radius: 10px;
}

.camera-controls {
  display: flex;
  gap: 15px;
  margin-top: 20px;
  justify-content: center;
}

/* Responsive */
@media (max-width: 992px) {
  .member-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  .member-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .form-actions {
    flex-direction: column;
  }
  
  .aadhaar-images {
    grid-template-columns: 1fr;
  }
  
  .file-input-container {
    flex-direction: column;
    align-items: stretch;
  }
  
  .camera-btn {
    width: 100%;
    justify-content: center;
    padding: 12px;
  }
}

@media (max-width: 480px) {
  .app {
    padding: 15px;
  }
  
  .member-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .add-btn {
    justify-content: center;
  }
  
  .member-card {
    aspect-ratio: auto;
    min-height: 160px;
    padding: 20px 15px;
  }
  
  .member-card img {
    width: 100px;
        height: 100px;
  }
}

.main-title{
text-shadow: 0 1px 0 #ccc, 
               0 2px 0 #c9c9c9,
               0 3px 0 #bbb,
               0 4px 0 #b9b9b9,
               0 5px 0 #aaa,
               0 6px 1px rgba(0,0,0,.1),
               0 0 5px rgba(0,0,0,.1),
               0 1px 3px rgba(0,0,0,.3),
               0 3px 5px rgba(0,0,0,.2),
               0 5px 10px rgba(0,0,0,.25),
               0 10px 10px rgba(0,0,0,.2),
               0 20px 20px rgba(0,0,0,.15);
text-align: center;
    font-size: 28px;
}
.title-picture {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
}
.title-picture img{
  width: 50px;
}
</style>
</head>

<body>

<div class="app">

  <!-- Header -->
  <header class="header">
  <div class="title-picture">
    <img src="title1-removebg-preview.png" alt="">
      <h2 class="main-title">Tirupati Seva</h2>
<img src="title2-removebg-preview.png" alt="">
  </div>
    <button id="openFormBtn" class="add-btn">
      <i class="fas fa-user-plus"></i>
      <span>Add New Member</span>
    </button>
  </header>

  <!-- Members Grid -->
  <section class="members-container">
    <div class="member-count" id="memberCount">0 members</div>
    <div id="memberGrid" class="member-grid"></div>
  </section>

  <!-- Add Member Form -->
  <section id="formSection" class="form-section hidden">
    <h3>Add New Member</h3>

    <form id="memberForm">
      <div class="form-group">
        <label for="name">Full Name *</label>
        <input type="text" id="name" placeholder="Enter full name" required>
      </div>

      <div class="form-group">
        <label for="mobile">Mobile Number *</label>
        <input type="tel" id="mobile" placeholder="Enter 10-digit mobile number" required>
      </div>

      <div class="form-group">
        <label for="email">Email Address *</label>
        <input type="email" id="email" placeholder="Enter email address" required>
      </div>

      <!-- Profile Photo with Camera Option -->
      <div class="form-group">
        <label>Profile Photo *</label>
        <div class="file-input-wrapper">
          <div class="file-input-btn">
            <i class="fas fa-camera"></i>
            <span>Choose Profile Photo</span>
          </div>
          <input type="file" id="profilePhoto" accept="image/*" required>
        </div>
        <div class="file-input-container">
          <button type="button" class="camera-btn" onclick="openCamera(document.getElementById('profilePhoto'))">
            <i class="fas fa-camera"></i> Take Photo
          </button>
          <div class="file-selection">
            <p>Or select from gallery</p>
          </div>
        </div>
        <div id="profilePhotoName" class="file-name"></div>
        <div id="profilePhotoProgress" class="progress-container hidden">
          <div class="progress-bar">
            <div class="progress-fill" id="profilePhotoProgressFill"></div>
          </div>
          <div class="progress-text" id="profilePhotoProgressText">0%</div>
        </div>
      </div>

      <!-- Aadhaar Front with Camera Option -->
      <div class="form-group">
        <label>Aadhaar Card ‚Äì Front *</label>
        <div class="file-input-wrapper">
          <div class="file-input-btn">
            <i class="fas fa-id-card"></i>
            <span>Choose Aadhaar Front</span>
          </div>
          <input type="file" id="aadhaarFront" accept="image/*" required>
        </div>
        <div class="file-input-container">
          <button type="button" class="camera-btn" onclick="openCamera(document.getElementById('aadhaarFront'))">
            <i class="fas fa-camera"></i> Capture Front
          </button>
          <div class="file-selection">
            <p>Or select from gallery</p>
          </div>
        </div>
        <div id="aadhaarFrontName" class="file-name"></div>
        <div id="aadhaarFrontProgress" class="progress-container hidden">
          <div class="progress-bar">
            <div class="progress-fill" id="aadhaarFrontProgressFill"></div>
          </div>
          <div class="progress-text" id="aadhaarFrontProgressText">0%</div>
        </div>
      </div>

      <!-- Aadhaar Back with Camera Option -->
      <div class="form-group">
        <label>Aadhaar Card ‚Äì Back *</label>
        <div class="file-input-wrapper">
          <div class="file-input-btn">
            <i class="fas fa-id-card"></i>
            <span>Choose Aadhaar Back</span>
          </div>
          <input type="file" id="aadhaarBack" accept="image/*" required>
        </div>
        <div class="file-input-container">
          <button type="button" class="camera-btn" onclick="openCamera(document.getElementById('aadhaarBack'))">
            <i class="fas fa-camera"></i> Capture Back
          </button>
          <div class="file-selection">
            <p>Or select from gallery</p>
          </div>
        </div>
        <div id="aadhaarBackName" class="file-name"></div>
        <div id="aadhaarBackProgress" class="progress-container hidden">
          <div class="progress-bar">
            <div class="progress-fill" id="aadhaarBackProgressFill"></div>
          </div>
          <div class="progress-text" id="aadhaarBackProgressText">0%</div>
        </div>
      </div>

      <div id="formMessages"></div>

      <div class="form-actions">
        <button type="submit" class="submit-btn">
          <i class="fas fa-check"></i> Save Member
        </button>
        <button type="button" class="cancel-btn" id="cancelFormBtn">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </section>

</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal hidden">
  <div class="modal-content">
    <button class="close-btn" id="closeModal">
      <i class="fas fa-times"></i>
    </button>

    <img id="modalProfileImg" class="profile-img">
    <h3 id="modalName"></h3>

    <div class="modal-info">
      <div class="info-item">
        <i class="fas fa-phone"></i>
        <span><strong>Mobile:</strong> <span id="modalMobile"></span></span>
      </div>
      <div class="info-item">
        <i class="fas fa-envelope"></i>
        <span><strong>Email:</strong> <span id="modalEmail"></span></span>
      </div>
    </div>

    <div class="aadhaar-section">
      <h4>Aadhaar Card</h4>
      <div class="aadhaar-images">
        <div class="aadhaar-img-wrapper">
          <div class="aadhaar-label">Front Side</div>
          <img id="modalAadhaarFront" class="aadhaar-img">
        </div>
        <div class="aadhaar-img-wrapper">
          <div class="aadhaar-label">Back Side</div>
          <img id="modalAadhaarBack" class="aadhaar-img">
        </div>
      </div>
    </div>
  </div>
</div>



<script>
/* ================== CLOUDINARY CONFIGURATION ================== */
const CLOUDINARY_CONFIG = {
  CLOUD_NAME: "dusqegvab",
  UPLOAD_PRESET: "testPreset",
  FOLDER: "members_management"
};

/* ================== JSONBin.io CONFIGURATION ================== */
const JSONBIN_CONFIG = {
  BIN_ID: '69480018ae596e708fa89185',
  MASTER_KEY: '$2a$10$n.pglrUySD3I.DnHpXC3eeCFtcHmmW36bLXKvZxG5qJu65qhKW7yi',
  API_URL: 'https://api.jsonbin.io/v3/b'
};

// DOM Elements
const openFormBtn = document.getElementById("openFormBtn");
const cancelFormBtn = document.getElementById("cancelFormBtn");
const formSection = document.getElementById("formSection");
const form = document.getElementById("memberForm");
const grid = document.getElementById("memberGrid");
const memberCount = document.getElementById("memberCount");
const formMessages = document.getElementById("formMessages");
const modal = document.getElementById("profileModal");
const closeModal = document.getElementById("closeModal");

// File input displays
const profilePhotoInput = document.getElementById("profilePhoto");
const aadhaarFrontInput = document.getElementById("aadhaarFront");
const aadhaarBackInput = document.getElementById("aadhaarBack");
const profilePhotoName = document.getElementById("profilePhotoName");
const aadhaarFrontName = document.getElementById("aadhaarFrontName");
const aadhaarBackName = document.getElementById("aadhaarBackName");

// Progress elements
const profilePhotoProgress = document.getElementById("profilePhotoProgress");
const profilePhotoProgressFill = document.getElementById("profilePhotoProgressFill");
const profilePhotoProgressText = document.getElementById("profilePhotoProgressText");
const aadhaarFrontProgress = document.getElementById("aadhaarFrontProgress");
const aadhaarFrontProgressFill = document.getElementById("aadhaarFrontProgressFill");
const aadhaarFrontProgressText = document.getElementById("aadhaarFrontProgressText");
const aadhaarBackProgress = document.getElementById("aadhaarBackProgress");
const aadhaarBackProgressFill = document.getElementById("aadhaarBackProgressFill");
const aadhaarBackProgressText = document.getElementById("aadhaarBackProgressText");

// Global members array (stores metadata with Cloudinary URLs)
let members = [];

// Camera variables
let cameraStream = null;
let currentCameraInput = null;
let capturedPhotoData = null;
let currentFacingMode = 'environment'; // Track current camera facing mode

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
  setupEventListeners();
  loadMembers(); // Load from JSONBin on startup
});

function setupEventListeners() {
  // Form toggle
  openFormBtn.addEventListener("click", openForm);
  cancelFormBtn.addEventListener("click", closeForm);

  // Form submission
  form.addEventListener("submit", handleFormSubmit);

  // File input handlers
  profilePhotoInput.addEventListener("change", function(e) {
    if (e.target.files[0]) {
      profilePhotoName.textContent = `üì∏ ${e.target.files[0].name}`;
    }
  });

  aadhaarFrontInput.addEventListener("change", function(e) {
    if (e.target.files[0]) {
      aadhaarFrontName.textContent = `üì∏ ${e.target.files[0].name}`;
    }
  });

  aadhaarBackInput.addEventListener("change", function(e) {
    if (e.target.files[0]) {
      aadhaarBackName.textContent = `üì∏ ${e.target.files[0].name}`;
    }
  });

  // Modal
  closeModal.addEventListener("click", closeProfileModal);
  modal.addEventListener("click", function(e) {
    if (e.target === modal) closeProfileModal();
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      closeProfileModal();
    }
  });
}

// ================== CLOUDINARY UPLOAD FUNCTIONS ==================

async function uploadToCloudinary(file, imageType, onProgress) {
  return new Promise((resolve, reject) => {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_CONFIG.UPLOAD_PRESET);
    formData.append("folder", `${CLOUDINARY_CONFIG.FOLDER}/${imageType}`);
    
    // Add timestamp for unique filename
    const timestamp = Date.now();
    formData.append("public_id", `${imageType}_${timestamp}`);
    
    const xhr = new XMLHttpRequest();
    
    // Track upload progress
    if (onProgress) {
      xhr.upload.addEventListener('progress', (event) => {
        if (event.lengthComputable) {
          const percentComplete = Math.round((event.loaded / event.total) * 100);
          onProgress(percentComplete);
        }
      });
    }
    
    xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.CLOUD_NAME}/image/upload`);
    
    xhr.onload = function() {
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);
        resolve({
          success: true,
          url: response.secure_url,
          publicId: response.public_id
        });
      } else {
        reject(new Error('Upload failed'));
      }
    };
    
    xhr.onerror = function() {
      reject(new Error('Network error'));
    };
    
    xhr.send(formData);
  });
}

// Upload multiple images to Cloudinary
async function uploadImagesToCloudinary(profileFile, frontFile, backFile) {
  try {
    showMessage('Uploading images to cloud...', 'info');
    
    // Create loading progress states
    const uploadResults = {
      profile: { success: false, url: null, publicId: null },
      front: { success: false, url: null, publicId: null },
      back: { success: false, url: null, publicId: null }
    };
    
    // Show progress containers
    profilePhotoProgress.classList.remove('hidden');
    aadhaarFrontProgress.classList.remove('hidden');
    aadhaarBackProgress.classList.remove('hidden');
    
    // Upload all images in parallel with progress tracking
    const uploadPromises = [];
    
    uploadPromises.push(
      uploadToCloudinary(profileFile, 'profile', (progress) => {
        profilePhotoProgressFill.style.width = `${progress}%`;
        profilePhotoProgressText.textContent = `${progress}%`;
      }).then(result => {
        uploadResults.profile = result;
      })
    );
    
    uploadPromises.push(
      uploadToCloudinary(frontFile, 'aadhaar_front', (progress) => {
        aadhaarFrontProgressFill.style.width = `${progress}%`;
        aadhaarFrontProgressText.textContent = `${progress}%`;
      }).then(result => {
        uploadResults.front = result;
      })
    );
    
    uploadPromises.push(
      uploadToCloudinary(backFile, 'aadhaar_back', (progress) => {
        aadhaarBackProgressFill.style.width = `${progress}%`;
        aadhaarBackProgressText.textContent = `${progress}%`;
      }).then(result => {
        uploadResults.back = result;
      })
    );
    
    await Promise.all(uploadPromises);
    
    // Hide progress containers
    profilePhotoProgress.classList.add('hidden');
    aadhaarFrontProgress.classList.add('hidden');
    aadhaarBackProgress.classList.add('hidden');
    
    if (uploadResults.profile.success && uploadResults.front.success && uploadResults.back.success) {
      return {
        success: true,
        profileUrl: uploadResults.profile.url,
        frontUrl: uploadResults.front.url,
        backUrl: uploadResults.back.url,
        profilePublicId: uploadResults.profile.publicId,
        frontPublicId: uploadResults.front.publicId,
        backPublicId: uploadResults.back.publicId
      };
    } else {
      throw new Error('Some images failed to upload');
    }
    
  } catch (error) {
    console.error('Cloudinary upload error:', error);
    
    // Hide progress containers
    profilePhotoProgress.classList.add('hidden');
    aadhaarFrontProgress.classList.add('hidden');
    aadhaarBackProgress.classList.add('hidden');
    
    return {
      success: false,
      error: error.message
    };
  }
}

// ================== FIXED CAMERA CAPTURE FUNCTIONS ==================

async function openCamera(inputElement) {
  try {
    // Stop any existing camera stream
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }
    
    // Store which input we're capturing for
    currentCameraInput = inputElement;
    capturedPhotoData = null;
    currentFacingMode = 'environment'; // Reset to back camera
    
    // Create camera modal
    const cameraModal = document.createElement('div');
    cameraModal.className = 'modal';
    cameraModal.id = 'cameraModal'; // Add ID for easy reference
    cameraModal.innerHTML = `
      <div class="modal-content" style="max-width: 500px;">
        <button class="close-btn" id="closeCameraModal">
          <i class="fas fa-times"></i>
        </button>
        
        <h3 style="text-align: center; margin-bottom: 20px;">
          <i class="fas fa-camera"></i> Take Photo
        </h3>
        
        <div class="camera-container">
          <!-- Live camera view -->
          <div id="cameraView" class="camera-view">
            <video id="cameraPreview" autoplay playsinline 
                   style="width: 100%; border-radius: 10px; background: #000;"></video>
          </div>
          
          <!-- Captured photo preview (hidden initially) -->
          <div id="photoPreview" class="photo-preview hidden" 
               style="width: 100%; max-height: 400px; overflow: hidden; border-radius: 10px; margin-bottom: 20px;">
            <img id="capturedPhoto" src="" style="width: 100%; height: auto; display: block; border-radius: 10px;">
            <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #666;">
              <i class="fas fa-check-circle" style="color: #28a745; margin-right: 5px;"></i>
              Photo captured successfully
            </div>
          </div>
          
          <!-- Camera controls -->
          <div id="cameraControls" class="camera-controls" style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
            <button id="captureBtn" class="submit-btn" style="flex: none; padding: 15px 30px;">
              <i class="fas fa-camera"></i> Capture
            </button>
            <button id="switchCameraBtn" class="cancel-btn" style="flex: none; padding: 15px 20px;">
              <i class="fas fa-sync-alt"></i> Switch Camera
            </button>
          </div>
          
          <!-- Retake/Confirm buttons (hidden initially) -->
          <div id="confirmControls" class="camera-controls hidden" style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
            <button id="retakeBtn" class="cancel-btn" style="flex: none; padding: 15px 30px;">
              <i class="fas fa-redo"></i> Retake
            </button>
            <button id="confirmBtn" class="submit-btn" style="flex: none; padding: 15px 30px;">
              <i class="fas fa-check"></i> Use Photo
            </button>
          </div>
          
          <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
            Position your document properly and ensure good lighting
          </p>
        </div>
      </div>
    `;
    
    document.body.appendChild(cameraModal);
    
    // Get DOM elements
    const video = document.getElementById('cameraPreview');
    const closeBtn = document.getElementById('closeCameraModal');
    const captureBtn = document.getElementById('captureBtn');
    const switchBtn = document.getElementById('switchCameraBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const cameraView = document.getElementById('cameraView');
    const photoPreview = document.getElementById('photoPreview');
    const cameraControls = document.getElementById('cameraControls');
    const confirmControls = document.getElementById('confirmControls');
    const capturedPhoto = document.getElementById('capturedPhoto');
    
    // Initialize camera
    await startCamera(video, currentFacingMode);
    
    // Event listeners
    closeBtn.addEventListener('click', () => {
      closeCameraModal();
    });
    
    captureBtn.addEventListener('click', () => {
      capturePhotoPreview(video, capturedPhoto, cameraView, photoPreview, cameraControls, confirmControls);
    });
    
    switchBtn.addEventListener('click', () => {
      switchCamera(video);
    });
    
    retakeBtn.addEventListener('click', () => {
      retakePhoto(video, cameraView, photoPreview, cameraControls, confirmControls);
    });
    
    confirmBtn.addEventListener('click', () => {
      if (capturedPhotoData) {
        applyCapturedPhoto(capturedPhotoData, inputElement);
        closeCameraModal();
        showMessage('‚úÖ Photo captured and applied successfully!', 'success');
      }
    });
    
    // Close on background click
    cameraModal.addEventListener('click', function(e) {
      if (e.target === cameraModal) {
        closeCameraModal();
      }
    });
    
  } catch (error) {
    console.error('Error accessing camera:', error);
    alert('Unable to access camera. Please check permissions or use file upload instead.');
    // Remove modal if camera fails
    const modal = document.getElementById('cameraModal');
    if (modal) modal.remove();
  }
}

// Start camera with specified facing mode
async function startCamera(videoElement, facingMode) {
  try {
    // Stop any existing stream
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
    }
    
    const constraints = {
      video: {
        facingMode: facingMode,
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      }
    };
    
    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
    videoElement.srcObject = cameraStream;
    
    // Update current facing mode
    currentFacingMode = facingMode;
    
    return true;
  } catch (error) {
    console.error('Error starting camera:', error);
    throw error;
  }
}

// Switch camera between front and back
async function switchCamera(videoElement) {
  try {
    // Determine new facing mode
    const newFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
    
    // Start camera with new facing mode
    await startCamera(videoElement, newFacingMode);
    
    // Update button text based on current camera
    const switchBtn = document.getElementById('switchCameraBtn');
    if (switchBtn) {
      const icon = newFacingMode === 'environment' ? 'fas fa-user' : 'fas fa-mobile-alt';
      switchBtn.innerHTML = `<i class="${icon}"></i> Switch Camera`;
    }
    
  } catch (error) {
    console.error('Error switching camera:', error);
    alert('Unable to switch camera. Please check if your device has multiple cameras.');
  }
}

// Retake photo - restart camera and show live view
function retakePhoto(videoElement, cameraView, photoPreview, cameraControls, confirmControls) {
  try {
    // Restart camera if it was stopped
    if (!cameraStream || cameraStream.getTracks().some(track => track.readyState === 'ended')) {
      startCamera(videoElement, currentFacingMode);
    }
    
    // Switch back to camera view
    cameraView.classList.remove('hidden');
    photoPreview.classList.add('hidden');
    cameraControls.classList.remove('hidden');
    confirmControls.classList.add('hidden');
    
    // Clear captured photo data
    capturedPhotoData = null;
    
  } catch (error) {
    console.error('Error in retake:', error);
    // If camera restart fails, just close and show error
    closeCameraModal();
    showMessage('Error restarting camera. Please try again.', 'error');
  }
}

function capturePhotoPreview(video, capturedPhotoElement, cameraView, photoPreview, cameraControls, confirmControls) {
  try {
    // Create canvas to capture photo
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    
    // Draw video frame to canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Get image data URL
    capturedPhotoData = canvas.toDataURL('image/jpeg', 0.9);
    
    // Show captured photo preview
    capturedPhotoElement.src = capturedPhotoData;
    
    // Switch views
    cameraView.classList.add('hidden');
    photoPreview.classList.remove('hidden');
    cameraControls.classList.add('hidden');
    confirmControls.classList.remove('hidden');
    
    // Stop camera stream to save battery (but keep reference)
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
    }
    
  } catch (error) {
    console.error('Error capturing photo preview:', error);
    alert('Error capturing photo. Please try again.');
  }
}

function applyCapturedPhoto(photoData, inputElement) {
  try {
    // Convert data URL to blob
    fetch(photoData)
      .then(res => res.blob())
      .then(blob => {
        // Create file from blob
        const file = new File([blob], `camera_${Date.now()}.jpg`, {
          type: 'image/jpeg',
          lastModified: Date.now()
        });
        
        // Create a DataTransfer object to set the file
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        
        // Set the file to the input
        inputElement.files = dataTransfer.files;
        
        // Update the display name
        const fileNameElement = inputElement.id === 'profilePhoto' ? profilePhotoName :
                              inputElement.id === 'aadhaarFront' ? aadhaarFrontName :
                              aadhaarBackName;
        fileNameElement.textContent = `üì∑ Camera Photo (${new Date().toLocaleTimeString()})`;
        
        // Trigger change event
        inputElement.dispatchEvent(new Event('change', { bubbles: true }));
      });
      
  } catch (error) {
    console.error('Error applying captured photo:', error);
    showMessage('Error applying photo. Please try again.', 'error');
  }
}

function closeCameraModal() {
  // Stop camera stream
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  
  // Remove modal
  const modal = document.getElementById('cameraModal');
  if (modal) {
    modal.remove();
  }
}

// ================== JSONBin.io API FUNCTIONS ==================

async function loadMembers() {
  try {
    showLoading(true);
    showMessage('Loading members from cloud...', 'info');
    
    const response = await fetch(
      `${JSONBIN_CONFIG.API_URL}/${JSONBIN_CONFIG.BIN_ID}/latest`,
      {
        headers: {
          'X-Master-Key': JSONBIN_CONFIG.MASTER_KEY
        }
      }
    );

    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }

    const data = await response.json();
    members = data.record?.members || [];
    
    // Fallback to localStorage if JSONBin is empty
    if (members.length === 0) {
      const localData = JSON.parse(localStorage.getItem('membersMetadata') || '[]');
      if (localData.length > 0) {
        members = localData;
        // Sync localStorage to JSONBin
        await saveAllMembersToJSONBin();
        showMessage('Local data synced to cloud!', 'success');
      }
    } else {
      // Sync JSONBin data to localStorage for offline access
      localStorage.setItem('membersMetadata', JSON.stringify(members));
    }

    renderMembers();
    updateMemberCount();
    showMessage(`‚úÖ Loaded ${members.length} members from cloud`, 'success');
    
  } catch (error) {
    console.error('Load error:', error);
    // Fallback to localStorage
    const localData = JSON.parse(localStorage.getItem('membersMetadata') || '[]');
    members = localData;
    
    renderMembers();
    updateMemberCount();
    showMessage('‚ö†Ô∏è Using offline data. Cloud sync failed.', 'error');
  } finally {
    showLoading(false);
  }
}

async function saveMemberToJSONBin(name, mobile, email, cloudinaryResult) {
  try {
    const memberId = Date.now().toString();
    
    // Create member object with Cloudinary URLs
    const member = {
      id: memberId,
      name: name,
      mobile: mobile,
      email: email,
      profilePhoto: cloudinaryResult.profileUrl,
      aadhaarFront: cloudinaryResult.frontUrl,
      aadhaarBack: cloudinaryResult.backUrl,
      profilePublicId: cloudinaryResult.profilePublicId,
      frontPublicId: cloudinaryResult.frontPublicId,
      backPublicId: cloudinaryResult.backPublicId,
      createdAt: new Date().toISOString()
    };

    // Add to local array
    members.unshift(member);
    
    // Save to JSONBin.io (only metadata, images are on Cloudinary)
    const response = await fetch(
      `${JSONBIN_CONFIG.API_URL}/${JSONBIN_CONFIG.BIN_ID}`,
      {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JSONBIN_CONFIG.MASTER_KEY
        },
        body: JSON.stringify({ members })
      }
    );

    if (!response.ok) {
      throw new Error(`Save failed: ${response.status}`);
    }

    // Save metadata to localStorage for offline access
    localStorage.setItem('membersMetadata', JSON.stringify(members));
    
    return { success: true, member: member };
    
  } catch (error) {
    console.error('Save error:', error);
    return { success: false, error: error.message };
  }
}

async function saveAllMembersToJSONBin() {
  try {
    const response = await fetch(
      `${JSONBIN_CONFIG.API_URL}/${JSONBIN_CONFIG.BIN_ID}`,
      {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JSONBIN_CONFIG.MASTER_KEY
        },
        body: JSON.stringify({ members })
      }
    );
    
    return response.ok;
  } catch (error) {
    console.error('Sync error:', error);
    return false;
  }
}

// ================== FORM HANDLING ==================

function openForm() {
  formSection.classList.remove("hidden");
  form.reset();
  clearFileNames();
  resetProgressBars();
  formMessages.innerHTML = '';
  formSection.scrollIntoView({ behavior: 'smooth' });
}

function closeForm() {
  formSection.classList.add("hidden");
  form.reset();
  clearFileNames();
  resetProgressBars();
  formMessages.innerHTML = '';
}

function clearFileNames() {
  profilePhotoName.textContent = '';
  aadhaarFrontName.textContent = '';
  aadhaarBackName.textContent = '';
}

function resetProgressBars() {
  // Hide progress containers
  profilePhotoProgress.classList.add('hidden');
  aadhaarFrontProgress.classList.add('hidden');
  aadhaarBackProgress.classList.add('hidden');
  
  // Reset progress bars
  profilePhotoProgressFill.style.width = '0%';
  profilePhotoProgressText.textContent = '0%';
  aadhaarFrontProgressFill.style.width = '0%';
  aadhaarFrontProgressText.textContent = '0%';
  aadhaarBackProgressFill.style.width = '0%';
  aadhaarBackProgressText.textContent = '0%';
}

function showMessage(message, type = 'error') {
  formMessages.innerHTML = `
    <div class="${type === 'error' ? 'error-msg' : 'success-msg'}">
      <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
      ${message}
    </div>
  `;
}

function showLoading(isLoading) {
  const submitBtn = form.querySelector('.submit-btn');
  if (isLoading && submitBtn) {
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    submitBtn.disabled = true;
  } else if (submitBtn) {
    submitBtn.innerHTML = '<i class="fas fa-check"></i> Save Member';
    submitBtn.disabled = false;
  }
}

async function handleFormSubmit(e) {
  e.preventDefault();
  formMessages.innerHTML = '';

  // Get form values
  const name = document.getElementById("name").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  const email = document.getElementById("email").value.trim();
  const profilePhoto = profilePhotoInput.files[0];
  const aadhaarFront = aadhaarFrontInput.files[0];
  const aadhaarBack = aadhaarBackInput.files[0];

  // Validation
  if (!name) {
    showMessage('Please enter full name');
    return;
  }

  if (!/^\d{10}$/.test(mobile)) {
    showMessage('Please enter valid 10-digit mobile number');
    return;
  }

  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    showMessage('Please enter valid email address');
    return;
  }

  if (!profilePhoto || !aadhaarFront || !aadhaarBack) {
    showMessage('Please upload or capture all required images');
    return;
  }

  // File size check (5MB max for Cloudinary)
  const maxSize = 5 * 1024 * 1024;
  if (profilePhoto.size > maxSize || aadhaarFront.size > maxSize || aadhaarBack.size > maxSize) {
    showMessage('Each image must be less than 5MB');
    return;
  }

  try {
    // Show loading
    const submitBtn = form.querySelector('.submit-btn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    submitBtn.disabled = true;

    // Step 1: Upload images to Cloudinary
    showMessage('Uploading images to Cloudinary...', 'info');
    const cloudinaryResult = await uploadImagesToCloudinary(profilePhoto, aadhaarFront, aadhaarBack);
    
    if (!cloudinaryResult.success) {
      throw new Error('Failed to upload images to cloud storage');
    }

    // Step 2: Save member metadata to JSONBin.io (with Cloudinary URLs)
    showMessage('Saving member data to database...', 'info');
    const saveResult = await saveMemberToJSONBin(name, mobile, email, cloudinaryResult);
    
    if (saveResult.success) {
      // Update UI
      renderMembers();
      updateMemberCount();
      
      // Show success
      showMessage('‚úÖ Member saved successfully! Images stored on Cloudinary.', 'success');
      
      // Close form after delay
      setTimeout(() => {
        closeForm();
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }, 2000);
    } else {
      throw new Error(saveResult.error);
    }

  } catch (error) {
    console.error('Form error:', error);
    showMessage(`Error: ${error.message}`, 'error');
    
    // Reset button
    const submitBtn = form.querySelector('.submit-btn');
    submitBtn.innerHTML = '<i class="fas fa-check"></i> Save Member';
    submitBtn.disabled = false;
  }
}

// ================== UI FUNCTIONS ==================

function renderMembers() {
  grid.innerHTML = '';
  
  if (members.length === 0) {
    grid.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-users"></i>
        <p>No members added yet</p>
        <small>Click "Add New Member" to get started</small>
      </div>
    `;
    return;
  }

  members.forEach(member => {
    const card = document.createElement("div");
    card.className = "member-card";
    card.innerHTML = `
      <img src="${member.profilePhoto || getPlaceholderImage('profile')}" 
           alt="${member.name}" 
           onerror="this.src='${getPlaceholderImage('profile')}'">
      <h4>${member.name}</h4>
    `;
    card.addEventListener("click", () => openProfileModal(member));
    grid.appendChild(card);
  });
}

function updateMemberCount() {
  const count = members.length;
  memberCount.textContent = `${count} member${count !== 1 ? 's' : ''}`;
}

function getPlaceholderImage(type) {
  const placeholders = {
    profile: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iNDAiIGZpbGw9IiNGRkZGRkUiLz4KPHBhdGggZD0iTTQwIDQ0QzQ0LjQxODMgNDQgNDggNDAuNDE4MyA0OCAzNkM0OCAzMS41ODE3IDQ0LjQxODMgMjggNDAgMjhDMzUuNTgxNyAyOCAzMiAzMS41ODE3IDMyIDM2QzMyIDQwLjQxODMgMzUuNTgxNyA0NCA0MCA0NFoiIGZpbGw9IiNFNUU1RTUiLz4KPHBhdGggZD0iTTUyIDUySDEyOEw2NCAzNkw1MiA1MloiIGZpbGw9IiNFNUU1RTUiLz4KPC9zdmc+',
    front: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDQwMCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMjUwIiByeD0iOCIgZmlsbD0iI0ZGRkZGRSIvPgo8cmVjdCB4PSIyMCIgeT0iMjAiIHdpZHRoPSIzNjAiIGhlaWdodD0iMjEwIiByeD0iNCIgZmlsbD0iI0U1RTVFNSIvPgo8cmVjdCB4PSI1MCIgeT0iNjAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAiIHJ4PSI0IiBmaWxsPSIjQ0NDQ0NDIi8+CjxyZWN0IHg9IjUwIiB5PSIxMTAiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAiIHJ4PSI0IiBmaWxsPSIjQ0NDQ0NDIiLz4+CjxyZWN0IHg9IjUwIiB5PSIxNDAiIHdpZHRoPSIxNTAiIGhlaWdodD0iMjAiIHJ4PSI0IiBmaWxsPSIjQ0NDQ0NDIiLz4KPC9zdmc+',
    back: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDQwMCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMjUwIiByeD0iOCIgZmlsbD0iI0ZGRkZGRSIvPgo8cmVjdCB4PSIyMCIgeT0iMjAiIHdpZHRoPSIzNjAiIGhlaWdodD0iMjEwIiByeD0iNCIgZmlsbD0iI0U1RTVFNSIvPgo8Y2lyY2xlIGN4PSIyMDAiIGN5PSI5MCIgcj0iNDAiIGZpbGw9IiNDQ0NDQ0MiLz4KPHJlY3QgeD0iNTAiIHk9IjE1MCIgd2lkdGg9IjMwMCIgaGVpZ2h0PSIyMCIgcng9IjQiIGZpbGw9IiNDQ0NDQ0MiLz4KPHJlY3QgeD0iNTAiIHk9IjE4MCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMCIgcng9IjQiIGZpbGw9IiNDQ0NDQ0MiLz4KPC9zdmc+'
  };
  return placeholders[type] || placeholders.profile;
}

function openProfileModal(member) {
  document.getElementById("modalProfileImg").src = member.profilePhoto || getPlaceholderImage('profile');
  document.getElementById("modalProfileImg").onerror = `this.src='${getPlaceholderImage('profile')}'`;
  document.getElementById("modalProfileImg").alt = member.name;
  document.getElementById("modalName").textContent = member.name;
  document.getElementById("modalMobile").textContent = member.mobile;
  document.getElementById("modalEmail").textContent = member.email;
  document.getElementById("modalAadhaarFront").src = member.aadhaarFront || getPlaceholderImage('front');
  document.getElementById("modalAadhaarFront").onerror = `this.src='${getPlaceholderImage('front')}'`;
  document.getElementById("modalAadhaarBack").src = member.aadhaarBack || getPlaceholderImage('back');
  document.getElementById("modalAadhaarBack").onerror = `this.src='${getPlaceholderImage('back')}'`;
  
  modal.classList.remove("hidden");
  document.body.style.overflow = 'hidden';
}

function closeProfileModal() {
  modal.classList.add("hidden");
  document.body.style.overflow = '';
}

// Add error handling for images
window.addEventListener('error', function(e) {
  if (e.target.tagName === 'IMG') {
    console.log('Image failed to load:', e.target.src);
  }
}, true);
</script>


</body>
</html>